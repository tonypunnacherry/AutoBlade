package $PACKAGE$;

import java.util.*;
import java.util.concurrent.ConcurrentMap;
import java.util.function.Supplier;

/**
 * Core algorithms for Repository operations.
 * Encapsulates creation, local lookup, and traversal strategies.
 */
public final class RepoOps {
    private RepoOps() {}

    /**
     * Atomic creation logic.
     * Uses computeIfAbsent for ConcurrentMaps to ensure thread-safety.
     */
    public static <T> T createAtomic(Map<String, T> cache, String id, Supplier<T> builder) {
        if (id == null) {
            throw new IllegalArgumentException("ID cannot be null for creation");
        }

        if (cache instanceof ConcurrentMap) {
            return ((ConcurrentMap<String, T>) cache).computeIfAbsent(id, k -> builder.get());
        }

        // Standard Map fallback (Check-then-act)
        synchronized (cache) {
            T existing = cache.get(id);
            if (existing != null) {
                return existing;
            }
            T created = builder.get();
            cache.put(id, created);
            return created;
        }
    }

    /**
     * Standard local lookup logic.
     */
    public static <T> T lookup(Map<String, T> cache, String id) {
        if (id == null) return null;
        return cache.get(id);
    }

    /**
     * Performs a deep search via the Global Registry and returns the first match.
     */
    public static <T> Optional<T> findFirst(BladeRegistry registry, String id) {
        return registry.find(id);
    }

    /**
     * Performs a deep search via the Global Registry and returns all matches.
     */
    public static <T> Set<T> findAll(BladeRegistry registry, String id, Class<T> type) {
        return registry.findAll(id, type);
    }

    /**
     * Hierarchical traversal logic for nested lookups.
     * e.g., Finding a project within a specific user.
     */
    public static <T> Optional<T> traverse(BladeRegistry registry, String parentId, String childId, Class<T> type) {
        return registry.findInParent(parentId, childId, type);
    }
}
